"use strict";!function(a){function b(){this.fetchContentFor=function(a){for(var c={},d=a.thirdPartyContent(),e=b.prototype.implList,f=0;f<e.length;f++){var g=e[f],h=g.id,i=g.provider,j=d[h],k=a.queryStrings[h];if(k){var l,m=!j||j.type===b.prototype.contentType.EMPTY;l=m?i.fetch(a):j.value,c[h]=l}}return c},this.fetchNodeContentFor=function(a){var b=this.fetchContentFor(a),c=a.id,d="";d+=`<!-- ko with: getPOIbyID('${c}') -->`,d+=`<!-- ko with: thirdPartyContent -->`;for(var e in b){var f=a.queryStrings[e];if(f){var g=b[e];d+=`<h3 class='info-heading'>${e}</h3>
<div class='info-content' data-bind="html: ${e}.value">${g}</div>`}}d+="<!-- /ko -->",d+="<!-- /ko --><!-- /ko -->";var h=document.createElement("DIV");return h.innerHTML=d,h}}b.prototype.contentType={},b.prototype.contentType.EMPTY="EMPTY",b.prototype.contentType.ERROR="ERROR",b.prototype.contentType.DATA="DATA",b.prototype.fetch=function(a){return""},b.prototype.implList=[],b.prototype.registerProvider=function(a,c){if(!(c&&c instanceof b))throw"Critical Error: Invalid class encountered when registering ContentProvider implementation!";b.prototype.implList.push({id:a,provider:c})};var c=function(){b.call(this)};c.prototype=Object.create(b.prototype),c.prototype.constructor=c,c.prototype.ContentID="Place",c.prototype.fetch=function(a){var d=a.queryStrings.Link,e=a.queryStrings.Place,f=d?`<a href="${d}" target="_blank">${e}</a>`:`<span>${a.title}</span>`,g=a.thirdPartyContent();return g[c.prototype.ContentID]={type:b.prototype.contentType.DATA,value:f},a.thirdPartyContent(g),f},b.prototype.registerProvider(c.prototype.ContentID,new c),a.ContentProvider=new b}(this),function(a,b){function c(a,b){return a.length>b?a.substring(0,b)+"...":a}function d(){e.constructor.call(this)}var e=Object.getPrototypeOf(a.ContentProvider);d.prototype=Object.create(e),d.prototype.constructor=d,d.prototype.ContentID="Wikipedia",d.prototype.fetch=function(a){var f=new Date,g="Loading content...",h="undefined"!=typeof Storage,i=h,j=encodeURIComponent(a.queryStrings[d.prototype.ContentID]),k=`https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&exintro=&explaintext=&titles=${j}&callback=?`,l=`https://en.wikipedia.org/wiki/${j}`,m=d.prototype.ContentID+"-"+a.id;if(h){var n={expiry:Date.parse(localStorage.getItem(m+"_expiry")),data:localStorage.getItem(m+"_data")};n.data&&n.expiry&&n.expiry>f.getTime()&&(g=`<p>${n.data} <a href="${l}" target="_blank">read more...</a></p>`,i=!1)}var o=a.thirdPartyContent();return o[d.prototype.ContentID]={type:i?e.contentType.EMPTY:e.contentType.DATA,value:g},a.thirdPartyContent(o),i&&b.ajax({type:"GET",url:k,contentType:"application/json; charset=utf-8",dataType:"json",success:function(b,g,i){var j="...";for(var k in b.query.pages){var n=b.query.pages[k],j=n.extract;break}j=c(j,350);var o=a.thirdPartyContent();if(h){var p=new Date;p.setDate(f.getDate()+1),localStorage.setItem(m+"_expiry",p),localStorage.setItem(m+"_data",j)}o[d.prototype.ContentID]={type:e.contentType.DATA,value:`<p>${j} <a href="${l}" target="_blank">read more...</a></p>`},a.thirdPartyContent(o)},error:function(b,c,f){console.error(f);var g=a.thirdPartyContent();g[d.prototype.ContentID]={type:e.contentType.ERROR,value:"Loading content failed with "+c},a.thirdPartyContent(g)}}),`<span>${g}<span>`},e.registerProvider(d.prototype.ContentID,new d)}(this,jQuery);var CIRCLE="M 0 -40 A 16 16 0 0 0 -16 -24 A 16 16 0 0 0 -4.8398438 -8.7558594 C -2.9451666 -4.6084785 -1.7424308 -1.1396568 0 0 C 1.7448585 -1.1412448 2.9483297 -4.618317 4.8476562 -8.7734375 A 16 16 0 0 0 16 -24 A 16 16 0 0 0 0 -40 z ",app=function(ko,google,map){function stringStartsWith(a,b){if(a=a||"",b.length>a.length)return!1;var c=a.substring(0,b.length)===b;return c}function setupPoi3rdPartyContentContainer(a){var b=a.thirdPartyContent;return b||(b=ko.observable({}),a.thirdPartyContent=b),a}function getInfoWindowFor(a){if(a){setupPoi3rdPartyContentContainer(a);var b,c=a.id;if(c&&(b=infoWindows[c],!b)){var d=ContentProvider.fetchNodeContentFor(a);d.isBound=!1,b=new google.maps.InfoWindow({content:d}),b.addListener("domready",function(){if(!d.isBound){try{ko.applyBindings(appViewModel,d)}catch(a){console.error(a)}d.isBound=!0}}),infoWindows[c]=b}return b}}function getMapMarkerFor(poi){function clickListenerFor(a,b){return function(){animateMarker(a.id),getInfoWindowFor(a).open(map,b)}}var id=poi.id,marker;if(id&&(marker=mapMarkers[id],!marker)){var myLatlng=new google.maps.LatLng(poi.loc.lat,poi.loc.lng);if(poi.icon&&poi.icon.icon&&poi.icon.style){var icon=poi.icon.icon,iconStyle=poi.icon.style;icon.path=eval(icon.path),marker=new Marker({position:myLatlng,title:poi.title,icon:icon,map_icon_label:`<span class="map-icon ${iconStyle}"></span>`,map:map,visible:!0})}else marker=new google.maps.Marker({position:myLatlng,title:poi.title,map:map,visible:!0});marker.id=id,marker.addListener("click",clickListenerFor(poi,marker)),mapMarkers[id]=marker}return marker}function animateMarker(a){function b(a){return function(){a.setAnimation(null)}}for(var c in mapMarkers){var d=c===a?mapMarkers[c].getAnimation():null,e=c!==a||d?null:google.maps.Animation.BOUNCE;if(mapMarkers[c].setAnimation(e),e){var f=mapMarkers[c];setTimeout(b(f),5e3)}}}function centerMap(a){var b=new google.maps.LatLng(a.lat,a.lng);map.panTo(b),map.setZoom(14)}function enablePOIs(a){var b={};for(var c in mapMarkers)mapMarkers[c].visible&&(b[c]=mapMarkers[c]);for(var d=0;d<a.length;d++){var e=a[d];if("no-results"!==e.id){var f=getMapMarkerFor(e);f.setVisible(!0),delete b[e.id]}}for(c in b)b[c].setVisible(!1)}function zoomToBounds(a){function b(a){for(var b={lat:75,lng:0},c={lat:-75,lng:-180},d=0;d<a.length;d++){var e=a[d];if(!e.loc)return null;b.lat=Math.min(e.loc.lat,b.lat),b.lng=Math.min(e.loc.lng,b.lng),c.lat=Math.max(e.loc.lat,c.lat),c.lng=Math.max(e.loc.lng,c.lng)}var f=5e-4;return b.lat*=1-f,b.lng*=1+f,c.lat*=1+f,c.lng*=1-f,new google.maps.LatLngBounds(b,c)}var c=b(a);c&&map.fitBounds(c)}function MapAppViewModel(){var a=this;a.poiList=ko.observableArray(),a.filterQuery=ko.observable(localStorage.getItem("filterQuery")||""),a.activeId=ko.observable(),a.filterQuery.subscribe(function(a){localStorage.setItem("filterQuery",a)}),a.filteredPOIlist=ko.computed(function(){var b=a.filterQuery().toLowerCase();if(b){var c=ko.utils.arrayFilter(a.poiList(),function(a){for(var c=a.keywords||[],d=!1,e=0;e<c.length&&!d;e++){var f=c[e].toLowerCase();d|=stringStartsWith(f,b)}return d});return 0===c.length&&c.push({id:"no-results",title:"No results",description:"Try some of these:",keywords:["science","art","unm","nob hill","transportation"]}),c}return a.poiList()},a),a.getPOIbyID=function(b){var c=ko.utils.arrayFilter(a.poiList(),function(a){return a.id===b});return c[0]},$.getJSON("poi.json",function(b){a.poiList(b)}),a.openNavArea=function(){$navTrigger.checked=!0},a.filteredPOIlist.extend({rateLimit:350}),a.filteredPOIlist.subscribe(function(a){enablePOIs(a),zoomToBounds(a)}),a.selectMapMarker=function(b){if("no-results"!==b.id){var c=b.id!==a.activeId()?b:null,d=c?c.id:null,e=a.activeId(),f=a.getPOIbyID(e);if(a.activeId(d),animateMarker(d),c){centerMap(b.loc);var g=getMapMarkerFor(b),h=getInfoWindowFor(f);h&&h.close(),getInfoWindowFor(b).open(map,g)}window.matchMedia("(min-width: 630px)").matches||($navTrigger.checked=!1)}},a.isSelected=function(b){return b.id===a.activeId()},enablePOIs(a.filteredPOIlist())}var $navTrigger=document.getElementById("nav-trigger"),$map=document.getElementById("map");window.matchMedia("(min-width: 630px)").matches&&($navTrigger.checked=!0);var mapMarkers={},infoWindows={},appViewModel=new MapAppViewModel;ko.applyBindings(appViewModel)}(ko,google,map);